000100 IDENTIFICATION DIVISION.                                                R
000200 PROGRAM-ID.        REPT020.
000300
000400 AUTHOR.            BILLY FENWICK
000500
000600****************************************
000610*     (C) COPYRIGHT BILLY FENWICK
000620****************************************
000600*
000700*
000800 ENVIRONMENT DIVISION.
000900 CONFIGURATION SECTION.
001000 INPUT-OUTPUT SECTION.
001100 FILE-CONTROL.
001200     SELECT TITLE-FILE   ASSIGN TO DA-TITLE
001300                         ORGANIZATION IS INDEXED
001400                         ACCESS IS SEQUENTIAL
001500                         FILE STATUS IS TIT-STATUS
001600                         RECORD KEY IS TI-KEY.
001700     SELECT GET-DETAIL         ASSIGN TO UT-S-RPTIN.
001800     SELECT ADD-INDEX-FILE     ASSIGN TO UT-S-IDXADD.
001900     SELECT ADD-HISTORY-FILE   ASSIGN TO UT-S-HSTADD.
002000     SELECT ADD-DETAIL-FILE    ASSIGN TO UT-S-DTLADD.
002100     SELECT REPORT-LIST-FILE   ASSIGN TO UT-S-REPTLST.
002200     SELECT CONTROL-CARD       ASSIGN TO UT-S-CNTLCRD.
002300 DATA DIVISION.
002400 FILE SECTION.
002500
002600 FD  TITLE-FILE
002700     RECORD CONTAINS 240 TO 310.
002800     COPY REPTB08 REPLACING ==:Z:== BY ==TI==.
002900     COPY REPTB09 REPLACING ==:Z:== BY ==RI==.
003000
003100 FD  GET-DETAIL
003200     RECORDING MODE IS F
003300     RECORD CONTAINS 133.
003400 01  G-RECORD.
003500     03 G-CONTROL              PIC X(1).
003600        88 PAGE-CONTROL VALUE '1' 'I' 'Â»'.
003700     03 G-LINE-REC             PIC X(132).
003800
003900 FD  ADD-INDEX-FILE
004000     BLOCK CONTAINS 0 RECORDS
004100     RECORDING MODE IS F
004200     LABEL RECORDS ARE STANDARD
004300     RECORD CONTAINS 57.
004400     COPY REPTB06 REPLACING ==:Z:== BY ==AI==.
004500
004600 FD  ADD-HISTORY-FILE
004700     RECORDING MODE IS F
004800     RECORD CONTAINS 100.
004900     COPY REPTB07 REPLACING ==:Z:== BY ==AT==.
005000
005100 FD  REPORT-LIST-FILE
005200     RECORDING MODE IS F
005300     RECORD CONTAINS 107.
005400 01  ADD-INDEX-H-RECORD.
005500     03 HS-REPORT-ID            PIC X(8).
005600     03 FILLER                  PIC X.
005700     03 HS-REPORT-SID           PIC X(8).
005800     03 FILLER                  PIC X.
005900     03 HS-REPORT-DATE          PIC 9(6).
006000     03 FILLER                  PIC X.
006100     03 HS-TITLE-NAME           PIC X(50).
006200     03 FILLER                  PIC X.
006300     03 HS-PAGES                PIC 9(7).
006400     03 FILLER                  PIC X.
006500     03 HS-LINES                PIC 9(9).
006600     03 FILLER                  PIC X.
006700     03 HS-REPORT-FILE          PIC X(06).
006800     03 FILLER                  PIC X.
006900     03 HS-STATUS               PIC X(01).
007000     03 FILLER                  PIC X(05).
007100
007200 FD  ADD-DETAIL-FILE
007300     RECORDING MODE IS V
007400     RECORD IS VARYING FROM 153 TO 11724
007500       DEPENDING ON DTL-LENGTH.
007600     COPY REPTB05 REPLACING ==:Z:== BY ==D==.
007700
007800 FD  CONTROL-CARD
007900     RECORDING MODE IS F
008000     RECORD CONTAINS 80.
008100 01  CARD-RECORD.
008200     03 FILLER                 PIC X(80).
008300
008400 WORKING-STORAGE SECTION.
008500 77  DTL-LENGTH    PIC 9(9)  COMP    VALUE ZERO.
008600 77  SUB-I         PIC 9(5)  COMP-3  VALUE ZERO.
008700 77  DI-COUNT      PIC 9(5)  COMP-3  VALUE ZERO.
008800 77  DO-LINE-COUNT PIC 9(5)  COMP-3  VALUE ZERO.
008900 77  D-COUNT       PIC 9(7)  COMP-3  VALUE ZERO.
009000 77  T-COUNT       PIC 9(7)  COMP-3  VALUE ZERO.
009100 77  K-COUNT       PIC 9(7)  COMP-3  VALUE ZERO.
009200 77  TI            PIC 9(5)  COMP-3  VALUE ZERO.
009300 77  TX            PIC 9(5)  COMP-3  VALUE ZERO.
009400 77  II            PIC 9(5)  COMP-3  VALUE ZERO.
009500 77  I             PIC 9(5)  COMP-3  VALUE ZEROS.
009600 77  N             PIC 9(5)  COMP-3  VALUE ZEROS.
009700 77  CHECK-I       PIC 9(5)  COMP-3  VALUE 200.
009800 77  CHECK-II      PIC 9(5)  COMP-3  VALUE 2000.
009900 77  SAVE-II       PIC 9(5)  COMP-3  VALUE ZERO.
010000 77  SAVE-III      PIC 9(5)  COMP-3  VALUE ZERO.
010100 77  SAVEZ-III     PIC 9(5)  COMP-3  VALUE ZERO.
010200 77  SAVEZ-II      PIC 9(5)  COMP-3  VALUE ZERO.
010300 77  FIRST-REC     PIC X(1)          VALUE 'Y'.
010400 77  FIRST-TIME    PIC X(1)          VALUE 'Y'.
010500 77  GOT-LINE1     PIC X(1)          VALUE 'N'.
010600 77  GOT-LINE2     PIC X(1)          VALUE 'N'.
010700 77  GOT-LINE3     PIC X(1)          VALUE 'N'.
010800 77  TITLE-POS1    PIC 9(5)  COMP-3  VALUE ZERO.
010900 77  TITLE-POS2    PIC 9(5)  COMP-3  VALUE ZERO.
011000 77  TITLE-POS3    PIC 9(5)  COMP-3  VALUE ZERO.
011100 77  TITLE-DATE-POS PIC 9(5)  COMP-3  VALUE ZERO.
011200 77  KEY-POS1      PIC 9(5)  COMP-3  VALUE ZERO.
011300 77  KEY-POS2      PIC 9(5)  COMP-3  VALUE ZERO.
011400 77  KEY-POS3      PIC 9(5)  COMP-3  VALUE ZERO.
011500 77  EOF-STATUS    PIC X(1)          VALUE 'N'.
011600 77  GOT-DTL       PIC X(1)          VALUE 'N'.
011700 77  IDX-LENGTH    PIC 9(5)  COMP-3  VALUE ZERO.
011800 77  TIT-STATUS    PIC X(2)          VALUE 'ZZ'.
011900 77  IDX-STATUS    PIC X(2)          VALUE 'ZZ'.
012000 77  GET-OUT-X     PIC X(1)          VALUE 'N'.
012100     88 GET-OUT VALUE 'Y'.
012200 77  DATE-USED     PIC X(1)          VALUE 'N'.
012300 77  SAVE-FILE-NAME PIC X(6)         VALUE SPACES.
012400 77  WORK-TEST     PIC X(50)         VALUE SPACES.
012500     88 FORCE-DATE VALUE 'Y'.
012600
012700 01  CARD-AREA.
012800     03  CARD-TYPE          PIC  X(1).
012900         88  CARD-APPL   VALUE 'A'.
013000         88  CARD-TITLE  VALUE 'T'.
013100     03  CARD-AREA-1.
013200         05  FILLER     OCCURS 19 TIMES.
013300             07  CARD-APPLICATION   PIC  X(3).
013400             07  FILLER             PIC  X(1).
013500         05  FILLER                 PIC  X(3).
013600     03  CARD-AREA-2 REDEFINES CARD-AREA-1.
013700         05  FILLER      OCCURS 8 TIMES.
013800             07  CARD-REPORT-ID     PIC  X(8).
013900             07  FILLER             PIC  X(1).
014000         05  FILLER             PIC  X(7).
014100     03  CARD-AREA-3 REDEFINES CARD-AREA-1.
014200         05  CARD-DATE          PIC  X(5).
014300             88  DATE-CARD VALUES 'DATE='.
014400         05  CARD-MM            PIC  9(2).
014500         05  CARD-DD            PIC  9(2).
014600         05  CARD-YY            PIC  9(2).
014700         05  FILLER             PIC  X(68).
014800
014900 01  TITLE-RECORD-ARRAY.
015000     02 T-RECORD-ARRAY  PIC X(310) OCCURS 200 TIMES.
015100 01  TITLE-RECORDS REDEFINES TITLE-RECORD-ARRAY.
015200     02 FILLER OCCURS 200 TIMES.
015300     COPY REPTB03 REPLACING ==:Z:== BY ==T==.
015400 01  REPORT-RECORDS-ARRAY REDEFINES TITLE-RECORD-ARRAY.
015500     02 FILLER OCCURS 200 TIMES.
015600     COPY REPTB04 REPLACING ==:Z:== BY ==R==.
015700        05 FILLER                 PIC X(70).
015800
015900 01  DO-SYSOUT.
016000     03 DO-REPORT-ID            PIC X(8).
016100     03 DO-REPORT-DATE          PIC 9(6).
016200     03 DO-PAGE-NUMBER          PIC S9(7)  COMP-3.
016300     03 DO-NUMBER-OF-LINES      PIC S9(3)  COMP-3.
016400     03 DO-LINES                PIC X(11704).
016500     03 FILLER  REDEFINES DO-LINES OCCURS 88 TIMES.
016600        05 DO-LINE                 PIC X(133).
016700
016800 01  INDEX-T-RECORD-ARRAY.
016900     02 TX-RECORD    OCCURS 2000 TIMES.
017000     COPY REPTB01 REPLACING ==:Z:== BY ==TX==.
017100
017200 01  INDEX-TZ-RECORD-ARRAY.
017300     02 TZ-RECORD    OCCURS 2000 TIMES.
017400     COPY REPTB01 REPLACING ==:Z:== BY ==TZ==.
017500
017600     COPY REPTB06 REPLACING ==:Z:== BY ==AO==.
017700
017800 01  WORK-AREA.
017900     03  D-PRT.
018000         05 FILLER PIC X(30) VALUE 'DETAIL RECORD COUNT = '.
018100         05 D-PRT-COUNT PIC  ZZZ,999.
018200     03  K-PRT.
018300         05 FILLER PIC X(30) VALUE 'INDEX RECORD COUNT = '.
018400         05 K-PRT-COUNT PIC  ZZZ,999.
018500     03  T-PRT.
018600         05 FILLER PIC X(30) VALUE 'HISTORY RECORD COUNT = '.
018700         05 T-PRT-COUNT PIC  ZZZ,999.
018800     03  WK-BANK            PIC  S9(3) COMP-3 VALUE ZEROS.
018900     03  WK-BRANCH          PIC  S9(3) COMP-3 VALUE ZEROS.
019000     03  WK-PAGE-COUNT      PIC  S9(7) COMP-3 VALUE ZEROS.
019100     03  WK-PAGE-COUNT-BRCH PIC  S9(7) COMP-3 VALUE ZEROS.
019200     03  WK-LINE-COUNT      PIC  S9(3) COMP-3 VALUE ZEROS.
019300     03  OLD-REPORT-ID      PIC  X(8) VALUE SPACES.
019400     03  OLD-REPORT-SID     PIC  X(8) VALUE SPACES.
019500     03  OLD-REPORT-DATE    PIC  9(6) VALUE ZEROS.
019600     03  OLD-BANK           PIC  S9(3) COMP-3 VALUE ZEROS.
019700     03  OLD-BRANCH         PIC  S9(3) COMP-3 VALUE ZEROS.
019800     03  SYSTEM-DAYS        PIC  S9(7) VALUE ZEROS COMP-3.
019900     03  TOTAL-DAYS         PIC  S9(7) VALUE ZEROS COMP-3.
020000     03  MONTH-DAYS         PIC  S9(7) VALUE ZEROS COMP-3.
020100     03  YEAR-CHECK         PIC   9(2) VALUE ZEROS.
020200     03  DAYS-IN-MONTH.
020300         05  FILLER PIC 9(2) VALUE 31.
020400         05  FILLER PIC 9(2) VALUE 28.
020500         05  FILLER PIC 9(2) VALUE 31.
020600         05  FILLER PIC 9(2) VALUE 30.
020700         05  FILLER PIC 9(2) VALUE 31.
020800         05  FILLER PIC 9(2) VALUE 30.
020900         05  FILLER PIC 9(2) VALUE 31.
021000         05  FILLER PIC 9(2) VALUE 31.
021100         05  FILLER PIC 9(2) VALUE 30.
021200         05  FILLER PIC 9(2) VALUE 31.
021300         05  FILLER PIC 9(2) VALUE 30.
021400         05  FILLER PIC 9(2) VALUE 31.
021500     03  DAYS REDEFINES DAYS-IN-MONTH PIC 9(2) OCCURS 12 TIMES.
021600     03  DATE-G PIC 9(8).
021700     03  FILLER REDEFINES DATE-G.
021800         05  DATE-YY  PIC 9(4).
021900         05  DATE-MM  PIC 9(2).
022000         05  DATE-DD  PIC 9(2).
022100     03  SYSTEM-DATE.
022200         05  SS-YY  PIC 9(4).
022300         05  SS-MM  PIC 9(2).
022400         05  SS-DD  PIC 9(2).
022500     03  REPORT-DATE   PIC 9(6).
022600     03  FILLER REDEFINES REPORT-DATE.
022700         05  RP-YY  PIC 9(2).
022800         05  RP-MM  PIC 9(2).
022900         05  RP-DD  PIC 9(2).
023000     03  IDX-KEY1      PIC X(20).
023100     03  IDX-KEY2      PIC X(20).
023200     03  IDX-KEY3      PIC X(20).
023300     03  FILLER        PIC X(50).
023400     EJECT
023500 LINKAGE SECTION.
023600 01  LINK-WORK-AREA.
023700     03  PARM-LENGTH   PIC S9(4) COMP.
023800     03  JOB-PARM      PIC X(5).
023900        88 DEBUG-ON  VALUE 'DEBUG'.
024000
024100 EJECT
024200 PROCEDURE DIVISION USING LINK-WORK-AREA.
024300
024400 0000-MAIN-ROUTINE.
024500*********************************************************
024600*     MAIN PROCESSING ROUTINE        ********************
024700*********************************************************
024800     IF PARM-LENGTH GREATER THAN 0
024900        DISPLAY 'JOB-PARM=' JOB-PARM.
025000     INITIALIZE INDEX-T-RECORD-ARRAY.
025100     INITIALIZE INDEX-TZ-RECORD-ARRAY.
025200     PERFORM 0100-PROCESS-CONTROL-CARD THRU
025300             0101-EXIT.
025400     PERFORM 0200-LOAD-TITLE-RECORDS THRU
025500             0299-EXIT.
025600     PERFORM 1000-PROCESS-INPUT-RECORDS THRU
025700             2999-EXIT.
025800     CLOSE GET-DETAIL.
025900     CLOSE ADD-INDEX-FILE ADD-DETAIL-FILE.
026000     PERFORM 3000-CREATE-TITLE-RECORDS THRU
026100             3999-EXIT.
026200     GO TO 9999-END-OF-PROGRAM.
026300
026400*********************************************************
026500*     READ ONE CONTROL CARD          ********************
026600*********************************************************
026700 0100-PROCESS-CONTROL-CARD.
026800     IF DEBUG-ON
026900        DISPLAY '0100-PRCESS-CONTROL-CARD'.
027000     OPEN INPUT CONTROL-CARD.
027100     READ CONTROL-CARD AT END GO TO 9900-NO-INPUT-CARD.
027200     MOVE CARD-RECORD TO CARD-AREA.
027300     IF DATE-CARD
027400        MOVE CARD-MM TO RP-MM
027500        MOVE CARD-DD TO RP-DD
027600        MOVE CARD-YY TO RP-YY
027700        MOVE 'Y' TO DATE-USED
027800      ELSE
027900        MOVE FUNCTION CURRENT-DATE (1:8) TO SYSTEM-DATE
028000        MOVE SS-YY TO RP-YY
028100        MOVE SS-MM TO RP-MM
028200        MOVE SS-DD TO RP-DD.
028300     IF DATE-CARD
028400        READ CONTROL-CARD AT END GO TO 9900-NO-INPUT-CARD.
028500     MOVE CARD-RECORD TO CARD-AREA.
028600     CLOSE CONTROL-CARD.
028700     IF DEBUG-ON
028800        DISPLAY 'REPORT-DATE=' REPORT-DATE.
028900
029000 0101-EXIT.  EXIT.
029100
029200*********************************************************
029300*     LOAD TITLE RECORDS INTO ARRAY  ********************
029400*********************************************************
029500 0200-LOAD-TITLE-RECORDS.
029600     IF DEBUG-ON
029700        DISPLAY '0200-LOAD-TITLE-RECORDS'.
029800     OPEN INPUT TITLE-FILE.
029900
030000 0210-GET-TITLE-RECORDS.
030100     IF CARD-APPL
030200        PERFORM 0220-CHECK-APPLICATIONS.
030300     IF CARD-TITLE
030400        PERFORM 0230-CHECK-TITLE-IDS.
030500     GO TO 0290-END-TITLE-RECORDS.
030600
030700 0220-CHECK-APPLICATIONS.
030800     READ TITLE-FILE  AT END GO TO 0290-END-TITLE-RECORDS.
030900     IF (TI-TYPE = 'T') AND (TI-EXTRACT = 'N')
031000         GO TO 0220-CHECK-APPLICATIONS.
031100     IF (RI-TYPE = 'R') AND (RI-EXTRACT = 'N')
031200         GO TO 0220-CHECK-APPLICATIONS.
031300     PERFORM 0222-CHECK-APPLS
031400            VARYING I FROM 1 BY 1
031500            UNTIL I EQUAL 19.
031600     GO TO 0220-CHECK-APPLICATIONS.
031700
031800 0222-CHECK-APPLS.
031900     IF DEBUG-ON
032000        DISPLAY 'CARD-APPL=' CARD-APPLICATION (I)
032100        DISPLAY 'TI-APPL=' TI-APPLICATION.
032200     IF CARD-APPLICATION (I) EQUAL SPACES
032300        GO TO 0220-CHECK-APPLICATIONS.
032400     IF TI-APPLICATION EQUAL CARD-APPLICATION (I)
032500        ADD +1 TO TI
032600        MOVE +19 TO I
032700        MOVE TI-RECORD TO T-RECORD-ARRAY (TI)
032800        IF DEBUG-ON
032900           DISPLAY 'TI-MOVE-RECORD-' T-RECORD-ARRAY (TI)
033000        END-IF
033100        GO TO 0220-CHECK-APPLICATIONS.
033200     IF I EQUAL CHECK-I
033300        CLOSE TITLE-FILE
033400        GO TO 9902-TITLE-ARRAY-ERROR.
033500
033600 0230-CHECK-TITLE-IDS.
033700     READ TITLE-FILE  AT END GO TO 0290-END-TITLE-RECORDS.
033800     IF (TI-TYPE = 'T') AND (TI-EXTRACT = 'N')
033900         GO TO 0230-CHECK-TITLE-IDS.
034000     IF (RI-TYPE = 'R') AND (RI-EXTRACT = 'N')
034100         GO TO 0230-CHECK-TITLE-IDS.
034200     PERFORM 0232-CHECK-IDS
034300            VARYING I FROM 1 BY 1
034400            UNTIL I EQUAL 8.
034500     GO TO 0230-CHECK-TITLE-IDS.
034600
034700 0232-CHECK-IDS.
034800     IF CARD-REPORT-ID (I) EQUAL SPACES
034900        GO TO 0230-CHECK-TITLE-IDS.
035000     IF TI-REPORT-ID EQUAL CARD-REPORT-ID (I)
035100        ADD +1 TO TI
035200        MOVE +8 TO I
035300        IF DEBUG-ON
035400           DISPLAY 'TI-MOVE-RECORD'
035500        END-IF
035600        MOVE TI-RECORD TO T-RECORD-ARRAY (TI)
035700        GO TO 0230-CHECK-TITLE-IDS.
035800     IF SUB-I EQUAL 200
035900        CLOSE TITLE-FILE
036000        GO TO 9902-TITLE-ARRAY-ERROR.
036100
036200 0290-END-TITLE-RECORDS.
036300     CLOSE TITLE-FILE.
036400     IF DEBUG-ON
036500        DISPLAY 'T-RECORDS LOADED=' TI.
036600
036700 0299-EXIT.  EXIT.
036800
036900*********************************************************
037000*     PROCESS SYSOUT RECORDS         ********************
037100*********************************************************
037200 1000-PROCESS-INPUT-RECORDS.
037300     IF DEBUG-ON
037400        DISPLAY '1000-PROCESS-INPUT-RECORDS'.
037500     OPEN INPUT GET-DETAIL.
037600     OPEN OUTPUT ADD-INDEX-FILE
037700                 ADD-DETAIL-FILE.
037800
037900 1020-READ-SYSOUT.
038000     READ GET-DETAIL AT END GO TO 2980-NO-MORE-SYSOUT.
038100     IF FIRST-REC EQUAL 'Y'
038200        MOVE 'N' TO FIRST-REC
038300        GO TO 1022-READ-SYSOUT.
038400     IF PAGE-CONTROL
038500        PERFORM 1200-PROCESS-SYSOUT THRU 1499-PROCESS-EXIT
038600        PERFORM 1450-START-NEW-PAGE.
038700
038800 1022-READ-SYSOUT.
038900     ADD +1 TO DI-COUNT.
039000     IF DI-COUNT GREATER THAN +88
039100        IF DEBUG-ON
039200           DISPLAY '**LINES DROPPED**'
039300        END-IF
039400*       PERFORM 1035-DROP-LINES
039500        GO TO 1020-READ-SYSOUT.
039600     MOVE G-RECORD TO DO-LINE (DI-COUNT).
039700     IF DEBUG-ON
039800        DISPLAY '#LINES=' DI-COUNT.
039900     GO TO 1020-READ-SYSOUT.
040000
040100 1200-PROCESS-SYSOUT.
040200     IF DEBUG-ON
040300        DISPLAY '1200-PROCESS-SYSOUT'.
040400     MOVE 'N' TO GOT-LINE1, GOT-LINE2, GOT-LINE3, GOT-DTL.
040500     PERFORM 1201-PROCESS-SYSOUT THRU 1279-EXIT
040600            VARYING I FROM 1 BY 1
040700            UNTIL I GREATER THAN TI.
040800     IF GOT-DTL = 'Y'
040900        PERFORM 2200-PROCESS-SYSOUT.
041000     PERFORM 1450-START-NEW-PAGE.
041100     IF EOF-STATUS EQUAL 'Y'
041200        GO TO 1499-PROCESS-EXIT.
041300     GO TO 1022-READ-SYSOUT.
041400
041500 1201-PROCESS-SYSOUT.
041600     IF DEBUG-ON
041700        DISPLAY '1201-PROCESS-SYSOUT ' I.
041800     IF T-TYPE (I) EQUAL 'R'
041900        GO TO 1279-EXIT.
042000     IF T-TID-LINE-1 (I) EQUAL ZERO
042100        GO TO 1203-PROCESS-NEXT.
042200     COMPUTE TITLE-POS1 =
042300      ((T-TID-LINE-1 (I) - 1) * 133) + T-TID-POSITION-1 (I).
042400     IF DEBUG-ON
042500        DISPLAY 'TITLE-POS1=' TITLE-POS1.
042600     MOVE DO-LINES (TITLE-POS1 :T-TID-LENGTH-1 (I)) TO WORK-TEST.
042700     IF DEBUG-ON
042800        DISPLAY 'DLINE=' WORK-TEST
042900        DISPLAY 'TID  =' T-TID-DATA-1 (I).
043000     IF DO-LINES (TITLE-POS1 :T-TID-LENGTH-1 (I)) EQUAL
043100         T-TID-DATA-1 (I)
043200        MOVE 'Y' TO GOT-LINE1
043300        GO TO 1203-PROCESS-NEXT
043400      ELSE
043500        GO TO 1279-EXIT.
043600
043700 1203-PROCESS-NEXT.
043800     IF DEBUG-ON
043900        DISPLAY '1203-PROCESS-NEXT '  I.
044000     IF T-TID-LINE-2 (I) EQUAL ZERO
044100        GO TO 1205-PROCESS-NEXT.
044200     COMPUTE TITLE-POS2 =
044300      ((T-TID-LINE-2 (I) - 1) * 133) + T-TID-POSITION-2 (I).
044400     IF DO-LINES (TITLE-POS2 :T-TID-LENGTH-2 (I)) EQUAL
044500         T-TID-DATA-2 (I)
044600        MOVE 'Y' TO GOT-LINE2
044700        GO TO 1205-PROCESS-NEXT
044800      ELSE
044900        GO TO 1279-EXIT.
045000
045100 1205-PROCESS-NEXT.
045200     IF DEBUG-ON
045300        DISPLAY '1205-PROCESS-NEXT ' I.
045400     IF T-TID-LINE-3 (I) EQUAL ZERO
045500        GO TO 1210-PROCESS-DATE.
045600     COMPUTE TITLE-POS2 =
045700      ((T-TID-LINE-3 (I) - 1) * 133) + T-TID-POSITION-3 (I).
045800      IF DO-LINES (TITLE-POS3:T-TID-LENGTH-3 (I)) EQUAL
045900         T-TID-DATA-3 (I)
046000        MOVE 'Y' TO GOT-LINE3
046100        GO TO 1210-PROCESS-DATE
046200      ELSE
046300        GO TO 1279-EXIT.
046400
046500 1210-PROCESS-DATE.
046600     IF DEBUG-ON
046700        DISPLAY '1210-PROCESS-DATE ' I.
046800     IF T-REPORT-ID (I) EQUAL OLD-REPORT-ID
046900        ADD +1 TO WK-PAGE-COUNT, WK-PAGE-COUNT-BRCH
047000      ELSE
047100        MOVE ZERO TO AO-SEQ
047200        MOVE +1 TO WK-PAGE-COUNT, WK-PAGE-COUNT-BRCH
047300      END-IF.
047400     MOVE T-REPORT-ID (I) TO OLD-REPORT-ID.
047500     MOVE T-REPORT-SID (I) TO OLD-REPORT-SID.
047600     MOVE 'Y' TO GOT-DTL.
047700     IF T-RDT-TYPE (I) EQUAL 'N'
047800        MOVE SS-MM TO RP-MM
047900        MOVE SS-DD TO RP-DD
048000        MOVE SS-YY TO RP-YY.
048100     COMPUTE TITLE-DATE-POS =
048200      ((T-RDT-LINE (I) - 1) * 133) + T-RDT-POSITION (I).
048300     IF T-RDT-TYPE (I) EQUAL 'R'
048400        MOVE DO-LINES (TITLE-DATE-POS:2) TO RP-MM
048500        ADD +3 TO TITLE-DATE-POS
048600        MOVE DO-LINES (TITLE-DATE-POS:2) TO RP-DD
048700        ADD +3 TO TITLE-DATE-POS
048800        MOVE DO-LINES (TITLE-DATE-POS:2) TO RP-YY.
048900     IF T-RDT-TYPE (I) EQUAL 'C'
049000        MOVE DO-LINES (TITLE-DATE-POS:2) TO RP-MM
049100        ADD +3 TO TITLE-DATE-POS
049200        MOVE DO-LINES (TITLE-DATE-POS:2) TO RP-DD
049300        ADD +5 TO TITLE-DATE-POS
049400        MOVE DO-LINES (TITLE-DATE-POS:2) TO RP-YY.
049500     IF T-RDT-TYPE (I) EQUAL 'Y'
049600        MOVE DO-LINES (TITLE-DATE-POS:2) TO RP-YY
049700        ADD +3 TO TITLE-DATE-POS
049800        MOVE DO-LINES (TITLE-DATE-POS:2) TO RP-MM
049900        ADD +3 TO TITLE-DATE-POS
050000        MOVE DO-LINES (TITLE-DATE-POS:2) TO RP-DD.
050100*  CHANGED TO FIX MULITPLE SAME REPORT-ID BUT DIFFERENT DATE
050200     IF REPORT-DATE EQUAL OLD-REPORT-DATE
050300        NEXT SENTENCE
050400       ELSE
050500        MOVE REPORT-DATE TO OLD-REPORT-DATE
050600        MOVE +1 TO WK-PAGE-COUNT, WK-PAGE-COUNT-BRCH.
050700     IF DEBUG-ON
050800        DISPLAY '1210- REPORT-DATE=' REPORT-DATE.
050900
051000 1220-BUILD-KEY.
051100     IF DEBUG-ON
051200        DISPLAY '1220-BUILD-KEY '    I.
051300     MOVE SPACES TO IDX-KEY1, IDX-KEY2, IDX-KEY3.
051400     IF T-KY1-LINE (I) EQUAL ZERO
051500        GO TO 1230-PROCESS-BANK-NUMBER.
051600     COMPUTE KEY-POS1 =
051700      ((T-KY1-LINE (I) - 1) * 133) + T-KY1-POSITION (I).
051800*    MOVE DO-LINES (KEY-POS1:T-KY1-LENGTH (I)) TO IDX-KEY1.
051900     MOVE DO-LINES (KEY-POS1:T-KY1-LENGTH (I))
052000                   TO IDX-KEY1 (1 :T-KY1-LENGTH (I)).
052100     IF DEBUG-ON
052200        DISPLAY 'KEY1=' IDX-KEY1.
052300     MOVE T-KY1-LENGTH (I) TO IDX-LENGTH.
052400     IF T-KY2-LINE (I) EQUAL ZERO
052500        GO TO 1230-PROCESS-BANK-NUMBER.
052600     COMPUTE KEY-POS2 =
052700      ((T-KY2-LINE (I) - 1) * 133) + T-KY2-POSITION (I).
052800     ADD T-KY2-LENGTH (I) TO IDX-LENGTH.
052900*    MOVE DO-LINES (KEY-POS2:T-KY2-LENGTH (I)) TO IDX-KEY2.
053000     MOVE DO-LINES (KEY-POS2:T-KY2-LENGTH (I))
053100                 TO IDX-KEY1 (IDX-LENGTH : T-KY2-LENGTH (I)).
053200     IF DEBUG-ON
053300        DISPLAY 'KEY2=' IDX-KEY1.
053400     IF T-KY3-LINE (I) EQUAL ZERO
053500        GO TO 1230-PROCESS-BANK-NUMBER.
053600     COMPUTE KEY-POS3 =
053700      ((T-KY3-LINE (I) - 1) * 133) + T-KY3-POSITION (I).
053800     ADD T-KY3-LENGTH (I) TO IDX-LENGTH.
053900*    MOVE DO-LINES (KEY-POS3:T-KY3-LENGTH (I)) TO IDX-KEY3.
054000     MOVE DO-LINES (KEY-POS3:T-KY3-LENGTH (I))
054100                 TO IDX-KEY1 (IDX-LENGTH : T-KY3-LENGTH (I)).
054200     IF DEBUG-ON
054300        DISPLAY 'KEY3=' IDX-KEY1.
054400
054500 1230-PROCESS-BANK-NUMBER.
054600     IF DEBUG-ON
054700        DISPLAY '1230-PROCESS-BANK'.
054800     IF T-FORCE-BANK (I) NOT EQUAL ZERO
054900        MOVE T-FORCE-BANK (I) TO WK-BANK
055000        MOVE ZERO TO WK-BRANCH
055100        GO TO 1250-WRITE-DETAIL.
055200     IF T-BANK-LINE (I) EQUAL ZERO
055300        MOVE T-FORCE-BANK (I) TO WK-BANK
055400        MOVE ZERO TO WK-BRANCH
055500        GO TO 1250-WRITE-DETAIL.
055600     COMPUTE KEY-POS1 =
055700      ((T-BANK-LINE (I) - 1) * 133) + T-BANK-POSITION (I).
055800     MOVE DO-LINES (KEY-POS1:T-BANK-LENGTH (I)) TO WK-BANK.
055900     IF (WK-BANK NOT NUMERIC)
056000        MOVE ZERO TO WK-BANK
056100        MOVE ZERO TO WK-BRANCH.
056200     IF DEBUG-ON
056300        DISPLAY '1230-BANK=' WK-BANK.
056400
056500 1240-PROCESS-BRANCH-NUMBER.
056600     IF DEBUG-ON
056700        DISPLAY '1240-PROCESS-BRANCH'.
056800     IF T-BRANCH-LINE (I) EQUAL ZERO
056900        MOVE ZERO TO WK-BRANCH
057000        GO TO 1250-WRITE-DETAIL.
057100     COMPUTE KEY-POS1 =
057200      ((T-BRANCH-LINE (I) - 1) * 133) + T-BRANCH-POSITION (I).
057300     MOVE DO-LINES (KEY-POS1:T-BRANCH-LENGTH (I)) TO WK-BRANCH.
057400     IF WK-BRANCH NOT NUMERIC
057500        MOVE ZERO TO WK-BRANCH.
057600     IF DEBUG-ON
057700        DISPLAY '1240-BRANCH=' WK-BRANCH.
057800     IF WK-BRANCH EQUAL OLD-BRANCH
057900        NEXT SENTENCE
058000        ELSE MOVE +1 TO WK-PAGE-COUNT-BRCH.
058100
058200 1250-WRITE-DETAIL.
058300     IF DEBUG-ON
058400        DISPLAY '1250-WRITE-DETAIL'
058500        DISPLAY 'DI-COUNT=' DI-COUNT.
058600     MOVE WK-BANK TO OLD-BANK,
058700     MOVE WK-BRANCH TO OLD-BRANCH.
058800     COMPUTE DTL-LENGTH = (DI-COUNT * 133) + 20.
058900     IF DEBUG-ON
059000        DISPLAY 'DTL-LENGTH=' DTL-LENGTH.
059100     MOVE T-REPORT-ID (I) TO D-REPORT-ID, DO-REPORT-ID.
059200     MOVE REPORT-DATE TO D-REPORT-DATE, DO-REPORT-DATE.
059300     MOVE WK-PAGE-COUNT TO D-SEQ, DO-PAGE-NUMBER.
059400     MOVE DI-COUNT TO D-NUMBER-OF-LINES, DO-NUMBER-OF-LINES.
059500     PERFORM 1251-COPY-DATA
059600             VARYING N FROM 1 BY 1
059700             UNTIL N > DI-COUNT.
059800     IF DEBUG-ON
059900        DISPLAY 'D-LRECL=' LENGTH OF D-RECORD.
060000     ADD +1 TO D-COUNT.
060100     WRITE D-RECORD INVALID KEY GO TO 9800-ERROR-WRITE-DETAIL.
060200     GO TO 1265-UPDATE-INDEX-ARRAY.
060300*    GO TO 1260-WRITE-INDEX-RECORD.
060400
060500 1251-COPY-DATA.
060600     MOVE DO-LINE(N) TO D-LINES(N).
060700     IF DEBUG-ON
060800        DISPLAY 'D-LINES=' D-LINES(N)
060900        DISPLAY '    N=  ' N.
061000
061100 1260-WRITE-INDEX-RECORD.
061200     IF DEBUG-ON
061300        DISPLAY '1260-WRITE-INDEX-RECORD'.
061400     MOVE 'K' TO AO-TYPE.
061500     MOVE T-REPORT-ID (I) TO AO-REPORT-ID.
061600     MOVE SPACES TO AO-REPORT-SID.
061700     MOVE REPORT-DATE TO AO-REPORT-DATE.
061800     MOVE WK-BANK TO AO-BANK.
061900     MOVE WK-BRANCH TO AO-BRANCH.
062000     MOVE WK-PAGE-COUNT TO AO-DSEQ.
062100     IF WK-BRANCH EQUAL ZERO
062200        MOVE TX-TOTAL-PAGES (SAVE-II) TO AO-SEQ
062300      ELSE
062400        MOVE TZ-TOTAL-PAGES (SAVE-III) TO AO-SEQ.
062500*    MOVE WK-PAGE-COUNT-BRCH TO AO-SEQ.
062600*    MOVE WK-PAGE-COUNT TO AO-DSEQ, AO-SEQ.
062700*    MOVE D-PAGE-NUMBER TO AO-SEQ.
062800     MOVE IDX-LENGTH TO AO-KEY-LENGTH.
062900     MOVE IDX-KEY1 TO AO-KEY-VALUE.
063000     MOVE AO-INDEX-RECORD TO AI-INDEX-RECORD.
063100     ADD +1 TO K-COUNT.
063200     WRITE AI-INDEX-RECORD
063300              INVALID KEY GO TO 9802-ERROR-INDEX-RECORD.
063400     IF WK-BRANCH EQUAL ZERO
063500       GO TO 1262-WRITE-EXIT.
063600     MOVE ZERO TO AO-BRANCH.
063700     MOVE TX-TOTAL-PAGES (SAVE-II) TO AO-SEQ.
063800     MOVE AO-INDEX-RECORD TO AI-INDEX-RECORD.
063900     ADD +1 TO K-COUNT.
064000     WRITE AI-INDEX-RECORD
064100              INVALID KEY GO TO 9802-ERROR-INDEX-RECORD.
064200
064300 1262-WRITE-EXIT. EXIT.
064400
064500 1265-UPDATE-INDEX-ARRAY.
064600     IF DEBUG-ON
064700        DISPLAY '1265-UPDATE-INDEX-ARRAY'.
064800     MOVE 'N' TO GET-OUT-X.
064900     PERFORM 1266-UPDATE-ENTRY THRU
065000             1269-UPDATE-EXIT
065100             VARYING II FROM 1 BY 1
065200        UNTIL GET-OUT.
065300     MOVE 'N' TO GET-OUT-X.
065400     PERFORM 1270-UPDATE-ENTRY THRU
065500                1275-UPDATE-EXIT
065600               VARYING II FROM 1 BY 1
065700             UNTIL GET-OUT.
065800     PERFORM 1260-WRITE-INDEX-RECORD THRU
065900             1262-WRITE-EXIT.
066000     GO TO 1279-EXIT.
066100
066200 1266-UPDATE-ENTRY.
066300     IF DEBUG-ON
066400        DISPLAY '1266-UPDATE-ENTRY-II=' II
066500        DISPLAY '1266-UPDATE-ENTRY-I=' I.
066600     IF II EQUAL CHECK-II
066700        GO TO 9903-TITLE-INDEX-ARRAY-ERROR.
066800     IF (TX-REPORT-ID (II) EQUAL SPACES) AND
066900           (TX-REPORT-SID (II) EQUAL SPACES) AND
067000*  FIX MORE THAN ONE DATE FOR SAME REPORT ID
067100              (TX-REPORT-DATE (II) EQUAL ZERO) AND
067200                 (TX-BANK (II) EQUAL ZERO) AND
067300                    (TX-BRANCH (II) EQUAL ZERO)
067400                      PERFORM 1267-ADD-ENTRY
067500                      MOVE II TO SAVE-II
067600                      GO TO 1269-UPDATE-EXIT
067700     END-IF.
067800     IF (TX-REPORT-ID (II) EQUAL R-REPORT-ID (I)) AND
067900          (TX-REPORT-SID (II) EQUAL SPACES) AND
068000*  FIX DUPLICATE DATE ON SAME REPORT ID
068100             (TX-REPORT-DATE (II) EQUAL REPORT-DATE) AND
068200                (TX-BANK (II) EQUAL WK-BANK) AND
068300                   (TX-BRANCH(II) EQUAL ZERO)
068400                      ADD +1 TO TX-TOTAL-PAGES (II)
068500                    ADD DO-NUMBER-OF-LINES TO TX-TOTAL-LINES (II)
068600                      MOVE II TO SAVE-II
068700                      MOVE 'Y' TO GET-OUT-X
068800                     IF DEBUG-ON
068900                      DISPLAY '1266-UPDATE-ENTRY-HIT=' II
069000                     END-IF
069100     END-IF.
069200     IF DEBUG-ON
069300        DISPLAY 'TX-REPORT-ID=' TX-REPORT-ID (II)
069400        DISPLAY 'TX-REPORT-SID=' TX-REPORT-SID (II)
069500        DISPLAY 'TX-REPORT-DATE=' TX-REPORT-DATE (II)
069600        DISPLAY 'TX-BANK=' TX-BANK (II)
069700        DISPLAY 'TX-BRANCH=' TX-BRANCH (II)
069800     END-IF.
069900     GO TO 1269-UPDATE-EXIT.
070000
070100 1267-ADD-ENTRY.
070200     IF DEBUG-ON
070300        DISPLAY '1267-ADD-ENTRY=' II.
070400     MOVE WK-BANK TO TX-BANK (II).
070500     MOVE ZERO TO TX-BRANCH (II).
070600     MOVE T-REPORT-ID (I) TO TX-REPORT-ID (II).
070700     MOVE SPACES TO TX-REPORT-SID (II).
070800     MOVE REPORT-DATE TO TX-REPORT-DATE (II).
070900     MOVE T-NAME (I) TO TX-TITLE-NAME (II).
071000     MOVE +1 TO TX-TOTAL-PAGES (II).
071100     MOVE DO-NUMBER-OF-LINES TO TX-TOTAL-LINES (II).
071200     MOVE T-REPORT-FILE (I) TO TX-REPORT-FILE (II),
071300      SAVE-FILE-NAME.
071400     MOVE 'Y' TO GET-OUT-X.
071500
071600 1269-UPDATE-EXIT. EXIT.
071700
071800 1270-UPDATE-ENTRY.
071900     IF DEBUG-ON
072000        DISPLAY '1270-UPDATE-ENTRY=' II.
072100     IF II EQUAL CHECK-II
072200        GO TO 9903-TITLE-INDEX-ARRAY-ERROR.
072300     IF (TZ-REPORT-ID (II) EQUAL SPACES) AND
072400           (TZ-REPORT-SID (II) EQUAL SPACES) AND
072500              (TZ-REPORT-DATE (II) EQUAL ZERO) AND
072600                 (TZ-BANK (II) EQUAL ZERO) AND
072700                    (TZ-BRANCH (II) EQUAL ZERO)
072800                      PERFORM 1274-ADD-ZERO
072900                      MOVE II TO SAVE-III
073000                      GO TO 1275-UPDATE-EXIT
073100     END-IF.
073200     IF (TZ-REPORT-ID (II) EQUAL R-REPORT-ID (I)) AND
073300          (TZ-REPORT-SID (II) EQUAL SPACES)  AND
073400             (TZ-REPORT-DATE (II) EQUAL REPORT-DATE) AND
073500                (TZ-BANK (II) EQUAL WK-BANK) AND
073600                    (TZ-BRANCH (II) EQUAL WK-BRANCH)
073700                      ADD +1 TO TZ-TOTAL-PAGES (II)
073800                    ADD DO-NUMBER-OF-LINES TO TZ-TOTAL-LINES (II)
073900                      MOVE II TO SAVE-III
074000                      MOVE 'Y' TO GET-OUT-X
074100                     IF DEBUG-ON
074200                      DISPLAY '1270-UPDATE-ENTRY HIT=' II
074300                     END-IF
074400     END-IF.
074500     IF DEBUG-ON
074600        DISPLAY 'TZ-REPORT-ID=' TZ-REPORT-ID (II)
074700        DISPLAY 'TZ-REPORT-SID=' TZ-REPORT-SID (II)
074800        DISPLAY 'TZ-REPORT-DATE=' TZ-REPORT-DATE (II)
074900        DISPLAY 'TZ-BANK=' TZ-BANK (II)
075000        DISPLAY 'TZ-BRANCH=' TZ-BRANCH (II).
075100     GO TO 1275-UPDATE-EXIT.
075200
075300 1274-ADD-ZERO.
075400     IF DEBUG-ON
075500        DISPLAY '1274-ADD-ZERO=' II.
075600     MOVE WK-BANK TO TZ-BANK (II).
075700     MOVE WK-BRANCH TO TZ-BRANCH (II).
075800     MOVE T-REPORT-ID (I) TO TZ-REPORT-ID (II).
075900     MOVE SPACES TO TZ-REPORT-SID (II).
076000     MOVE REPORT-DATE TO TZ-REPORT-DATE (II).
076100     MOVE T-NAME (I) TO TZ-TITLE-NAME (II).
076200     MOVE +1 TO TZ-TOTAL-PAGES (II).
076300     MOVE DO-NUMBER-OF-LINES TO TZ-TOTAL-LINES (II).
076400     MOVE T-REPORT-FILE (I) TO TZ-REPORT-FILE (II),
076500      SAVE-FILE-NAME.
076600     MOVE 'Y' TO GET-OUT-X.
076700     IF DEBUG-ON
076800        DISPLAY 'TZ-REPORT-ID=' TZ-REPORT-ID (II)
076900        DISPLAY 'TZ-REPORT-SID=' TZ-REPORT-SID (II)
077000        DISPLAY 'TZ-REPORT-DATE=' TZ-REPORT-DATE (II)
077100        DISPLAY 'TZ-BANK=' TZ-BANK (II)
077200        DISPLAY 'TZ-BRANCH=' TZ-BRANCH (II).
077300
077400 1275-UPDATE-EXIT.  EXIT.
077500
077600 1279-EXIT.  EXIT.
077700
077800 1450-START-NEW-PAGE.
077900     MOVE SPACES TO DO-REPORT-ID, DO-LINES.
078000     MOVE ZEROS TO DO-REPORT-DATE, DO-PAGE-NUMBER.
078100     MOVE ZEROS TO DO-NUMBER-OF-LINES.
078200     MOVE ZERO TO DI-COUNT.
078300
078400 1499-PROCESS-EXIT.  EXIT.
078500
078600 2200-PROCESS-SYSOUT.
078700     IF DEBUG-ON
078800        DISPLAY '2200-PROCESS-SYSOUT'.
078900     MOVE 'N' TO GOT-LINE1, GOT-LINE2, GOT-LINE3.
079000     PERFORM 2401-PROCESS-SYSOUT THRU 2479-EXIT
079100            VARYING I FROM 1 BY 1
079200            UNTIL I GREATER THAN TI.
079300
079400 2401-PROCESS-SYSOUT.
079500     IF DEBUG-ON
079600        DISPLAY '2401-PROCESS-SYSOUT ' I.
079700     IF R-TYPE (I) EQUAL 'T'
079800        GO TO 2479-EXIT.
079900     IF R-TID-LINE-1 (I) EQUAL ZERO
080000        GO TO 2403-PROCESS-NEXT.
080100     COMPUTE TITLE-POS1 =
080200      ((R-TID-LINE-1 (I) - 1) * 133) + R-TID-POSITION-1 (I).
080300     IF DEBUG-ON
080400        DISPLAY 'TITLE-POS1=' TITLE-POS1.
080500     MOVE DO-LINES (TITLE-POS1 :R-TID-LENGTH-1 (I)) TO WORK-TEST.
080600     IF DEBUG-ON
080700        DISPLAY 'DLINE=' WORK-TEST
080800        DISPLAY 'RID  =' R-TID-DATA-1 (I).
080900     IF DO-LINES (TITLE-POS1 :R-TID-LENGTH-1 (I)) EQUAL
081000         R-TID-DATA-1 (I)
081100        MOVE 'Y' TO GOT-LINE1
081200        GO TO 2403-PROCESS-NEXT
081300      ELSE
081400        GO TO 2479-EXIT.
081500
081600 2403-PROCESS-NEXT.
081700     IF DEBUG-ON
081800        DISPLAY '2403-PROCESS-NEXT '  I.
081900     IF R-TID-LINE-2 (I) EQUAL ZERO
082000        GO TO 2405-PROCESS-NEXT.
082100     COMPUTE TITLE-POS2 =
082200      ((R-TID-LINE-2 (I) - 1) * 133) + R-TID-POSITION-2 (I).
082300     IF DO-LINES (TITLE-POS2 :R-TID-LENGTH-2 (I)) EQUAL
082400         R-TID-DATA-2 (I)
082500        MOVE 'Y' TO GOT-LINE2
082600        GO TO 2405-PROCESS-NEXT
082700      ELSE
082800        GO TO 2479-EXIT.
082900
083000 2405-PROCESS-NEXT.
083100     IF DEBUG-ON
083200        DISPLAY '2405-PROCESS-NEXT ' I.
083300     IF R-TID-LINE-3 (I) EQUAL ZERO
083400        GO TO 2420-BUILD-KEY.
083500     COMPUTE TITLE-POS2 =
083600      ((R-TID-LINE-3 (I) - 1) * 133) + R-TID-POSITION-3 (I).
083700      IF DO-LINES (TITLE-POS3:R-TID-LENGTH-3 (I)) EQUAL
083800         R-TID-DATA-3 (I)
083900        MOVE 'Y' TO GOT-LINE3
084000        GO TO 2420-BUILD-KEY
084100      ELSE
084200        GO TO 2479-EXIT.
084300
084400 2420-BUILD-KEY.
084500     IF DEBUG-ON
084600        DISPLAY '2420-BUILD-KEY '    I.
084700     MOVE SPACES TO IDX-KEY1, IDX-KEY2, IDX-KEY3.
084800     IF R-KY1-LINE (I) EQUAL ZERO
084900        GO TO 2450-UPDATE-INDEX-ARRAY.
085000     COMPUTE KEY-POS1 =
085100      ((R-KY1-LINE (I) - 1) * 133) + R-KY1-POSITION (I).
085200*    MOVE DO-LINES (KEY-POS1:R-KY1-LENGTH (I)) TO IDX-KEY1.
085300     MOVE DO-LINES (KEY-POS1:R-KY1-LENGTH (I))
085400                 TO IDX-KEY1 (1 : R-KY1-LENGTH (I)).
085500     IF DEBUG-ON
085600        DISPLAY 'KEY1=' IDX-KEY1.
085700     MOVE R-KY1-LENGTH (I) TO IDX-LENGTH.
085800     IF R-KY2-LINE (I) EQUAL ZERO
085900        GO TO 2450-UPDATE-INDEX-ARRAY.
086000     COMPUTE KEY-POS2 =
086100      ((R-KY2-LINE (I) - 1) * 133) + R-KY2-POSITION (I).
086200     ADD R-KY2-LENGTH (I) TO IDX-LENGTH.
086300*    MOVE DO-LINES (KEY-POS2:R-KY2-LENGTH (I)) TO IDX-KEY2.
086400     MOVE DO-LINES (KEY-POS2:R-KY2-LENGTH (I))
086500                 TO IDX-KEY1 (IDX-LENGTH : R-KY2-LENGTH (I)).
086600     IF DEBUG-ON
086700        DISPLAY 'KEY2=' IDX-KEY1.
086800     IF R-KY3-LINE (I) EQUAL ZERO
086900        GO TO 2450-UPDATE-INDEX-ARRAY.
087000     COMPUTE KEY-POS3 =
087100      ((R-KY3-LINE (I) - 1) * 133) + R-KY3-POSITION (I).
087200     ADD R-KY3-LENGTH (I) TO IDX-LENGTH.
087300*    MOVE DO-LINES (KEY-POS3:R-KY3-LENGTH (I)) TO IDX-KEY3.
087400     MOVE DO-LINES (KEY-POS3:R-KY3-LENGTH (I))
087500                 TO IDX-KEY1 (IDX-LENGTH : R-KY3-LENGTH (I)).
087600     IF DEBUG-ON
087700        DISPLAY 'KEY3=' IDX-KEY1.
087800
087900 2450-UPDATE-INDEX-ARRAY.
088000     IF DEBUG-ON
088100        DISPLAY '2450-UPDATE-INDEX-ARRAY'.
088200     MOVE 'N' TO GET-OUT-X.
088300     PERFORM 2452-UPDATE-ENTRY THRU
088400             2459-UPDATE-EXIT
088500             VARYING II FROM 1 BY 1
088600        UNTIL GET-OUT.
088700     MOVE 'N' TO GET-OUT-X.
088800     PERFORM 2552-UPDATE-ENTRY THRU
088900             2559-UPDATE-EXIT
089000             VARYING II FROM 1 BY 1
089100        UNTIL GET-OUT.
089200     GO TO 2660-WRITE-INDEX-RECORD.
089300
089400 2452-UPDATE-ENTRY.
089500     IF DEBUG-ON
089600        DISPLAY '2452-UPDATE-ENTRY=' II.
089700     IF II EQUAL CHECK-II
089800        GO TO 9903-TITLE-INDEX-ARRAY-ERROR.
089900     IF (TX-REPORT-ID (II) EQUAL SPACES) AND
090000           (TX-REPORT-SID (II) EQUAL SPACES) AND
090100*  FIX DUPLICATE DATE ON SAME REPORT ID
090200              (TX-REPORT-DATE (II) EQUAL ZERO) AND
090300                 (TX-BANK (II) EQUAL ZERO) AND
090400                    (TX-BRANCH (II) EQUAL ZERO)
090500                       PERFORM 2453-ADD-ENTRY
090600                       MOVE II TO SAVEZ-III
090700                       GO TO 2459-UPDATE-EXIT
090800     END-IF.
090900     IF (TX-REPORT-ID (II) EQUAL R-REPORT-ID (I)) AND
091000          (TX-REPORT-SID (II) EQUAL R-REPORT-SID (I)) AND
091100*  FIX DUPLICATE DATE ON SAME REPORT ID
091200             (TX-REPORT-DATE (II) EQUAL REPORT-DATE) AND
091300                (TX-BANK (II) EQUAL WK-BANK) AND
091400                   (TX-BRANCH(II) EQUAL ZERO)
091500                      ADD +1 TO TX-TOTAL-PAGES (II)
091600                    ADD DO-NUMBER-OF-LINES TO TX-TOTAL-LINES (II)
091700                      MOVE II TO SAVEZ-III
091800                      MOVE 'Y' TO GET-OUT-X
091900                    IF DEBUG-ON
092000                      DISPLAY '2452-UPDATE-ENTRY-HIT=' II
092100                     END-IF
092200     END-IF.
092300     IF DEBUG-ON
092400        DISPLAY 'TX-REPORT-ID=' TX-REPORT-ID (II)
092500        DISPLAY 'TX-REPORT-SID=' TX-REPORT-SID (II)
092600        DISPLAY 'TX-REPORT-DATE=' TX-REPORT-DATE (II)
092700        DISPLAY 'TX-BANK=' TX-BANK (II)
092800        DISPLAY 'TX-BRANCH=' TX-BRANCH (II).
092900     GO TO 2459-UPDATE-EXIT.
093000
093100 2453-ADD-ENTRY.
093200     IF DEBUG-ON
093300        DISPLAY '2453-ADD-ENTRY=' II.
093400     MOVE WK-BANK TO TX-BANK (II).
093500     MOVE ZERO TO TX-BRANCH (II).
093600     MOVE R-REPORT-ID (I) TO TX-REPORT-ID (II).
093700     MOVE R-REPORT-SID (I) TO TX-REPORT-SID (II).
093800     MOVE R-NAME (I) TO TX-TITLE-NAME (II).
093900     MOVE REPORT-DATE TO TX-REPORT-DATE (II).
094000     MOVE SAVE-FILE-NAME TO TX-REPORT-FILE (II).
094100     MOVE +1 TO TX-TOTAL-PAGES (II).
094200     MOVE II TO SAVEZ-III.
094300     MOVE DO-NUMBER-OF-LINES TO TX-TOTAL-LINES (II).
094400     MOVE 'Y' TO GET-OUT-X.
094500     IF DEBUG-ON
094600        DISPLAY 'TX-REPORT-ID=' TX-REPORT-ID (II)
094700        DISPLAY 'TX-REPORT-SID=' TX-REPORT-SID (II)
094800        DISPLAY 'TX-REPORT-DATE=' TX-REPORT-DATE (II)
094900        DISPLAY 'TX-BANK=' TX-BANK (II)
095000        DISPLAY 'TX-BRANCH=' TX-BRANCH (II).
095100     GO TO 2459-UPDATE-EXIT.
095200
095300 2459-UPDATE-EXIT. EXIT.
095400
095500
095600 2552-UPDATE-ENTRY.
095700     IF DEBUG-ON
095800        DISPLAY '2552-UPDATE-ENTRY=' II.
095900     IF II EQUAL CHECK-II
096000        GO TO 9903-TITLE-INDEX-ARRAY-ERROR.
096100     IF (TZ-REPORT-ID (II) EQUAL SPACES) AND
096200           (TZ-REPORT-SID (II) EQUAL SPACES) AND
096300              (TZ-REPORT-DATE (II) EQUAL ZERO) AND
096400                 (TZ-BANK (II) EQUAL ZERO) AND
096500                    (TZ-BRANCH (II) EQUAL ZERO)
096600                       PERFORM 2553-ADD-ENTRY
096700                       MOVE II TO SAVEZ-II
096800                       GO TO 2559-UPDATE-EXIT
096900     END-IF.
097000     IF (TZ-REPORT-ID (II) EQUAL R-REPORT-ID (I)) AND
097100          (TZ-REPORT-SID (II) EQUAL R-REPORT-SID (I)) AND
097200             (TZ-REPORT-DATE (II) EQUAL REPORT-DATE) AND
097300                (TZ-BANK (II) EQUAL WK-BANK) AND
097400                   (TZ-BRANCH (II) EQUAL WK-BRANCH)
097500                      ADD +1 TO TZ-TOTAL-PAGES (II)
097600                    ADD DO-NUMBER-OF-LINES TO TZ-TOTAL-LINES (II)
097700                      MOVE II TO SAVEZ-II
097800                      MOVE 'Y' TO GET-OUT-X
097900                    IF DEBUG-ON
098000                      DISPLAY '2552-UPDATE-ENTRY-HIT=' II
098100                     END-IF
098200     END-IF.
098300     IF DEBUG-ON
098400        DISPLAY 'TZ-REPORT-ID=' TZ-REPORT-ID (II)
098500        DISPLAY 'TZ-REPORT-SID=' TZ-REPORT-SID (II)
098600        DISPLAY 'TZ-REPORT-DATE=' TZ-REPORT-DATE (II)
098700        DISPLAY 'TZ-BANK=' TZ-BANK (II)
098800        DISPLAY 'TZ-BRANCH=' TZ-BRANCH (II).
098900     GO TO 2559-UPDATE-EXIT.
099000
099100 2553-ADD-ENTRY.
099200     IF DEBUG-ON
099300        DISPLAY '2553-ADD-ENTRY=' II.
099400     MOVE WK-BANK TO TZ-BANK (II).
099500     MOVE WK-BRANCH TO TZ-BRANCH (II).
099600     MOVE R-REPORT-ID (I) TO TZ-REPORT-ID (II).
099700     MOVE R-REPORT-SID (I) TO TZ-REPORT-SID (II).
099800     MOVE REPORT-DATE TO TZ-REPORT-DATE (II).
099900     MOVE SAVE-FILE-NAME TO TZ-REPORT-FILE (II).
100000     MOVE +1 TO TZ-TOTAL-PAGES (II).
100100     MOVE II TO SAVEZ-II.
100200     MOVE DO-NUMBER-OF-LINES TO TZ-TOTAL-LINES (II).
100300     MOVE 'Y' TO GET-OUT-X.
100400     IF DEBUG-ON
100500        DISPLAY 'TZ-REPORT-ID=' TZ-REPORT-ID (II)
100600        DISPLAY 'TZ-REPORT-SID=' TZ-REPORT-SID (II)
100700        DISPLAY 'TZ-REPORT-DATE=' TZ-REPORT-DATE (II)
100800        DISPLAY 'TZ-BANK=' TZ-BANK (II)
100900        DISPLAY 'TZ-BRANCH=' TZ-BRANCH (II).
101000
101100 2559-UPDATE-EXIT. EXIT.
101200
101300 2660-WRITE-INDEX-RECORD.
101400     IF DEBUG-ON
101500        DISPLAY '2660-WRITE-INDEX-RECORD'
101600        DISPLAY 'II=' SAVE-II.
101700     MOVE 'K' TO AO-TYPE.
101800     MOVE R-REPORT-ID (I) TO AO-REPORT-ID.
101900     MOVE R-REPORT-SID (I) TO AO-REPORT-SID.
102000     MOVE REPORT-DATE TO AO-REPORT-DATE.
102100     MOVE WK-BANK TO AO-BANK.
102200     MOVE WK-BRANCH TO AO-BRANCH.
102300     IF WK-BRANCH EQUAL ZERO
102400        MOVE TX-TOTAL-PAGES (SAVEZ-III) TO AO-SEQ
102500      ELSE
102600        MOVE TZ-TOTAL-PAGES (SAVEZ-II) TO AO-SEQ.
102700     MOVE DO-PAGE-NUMBER TO AO-DSEQ.
102800     MOVE IDX-LENGTH TO AO-KEY-LENGTH.
102900     MOVE IDX-KEY1 TO AO-KEY-VALUE.
103000     MOVE AO-INDEX-RECORD TO AI-INDEX-RECORD.
103100     ADD +1 TO K-COUNT.
103200     WRITE AI-INDEX-RECORD INVALID KEY
103300              GO TO 9802-ERROR-INDEX-RECORD.
103400     IF WK-BRANCH EQUAL ZERO
103500        GO TO 2479-EXIT.
103600     MOVE ZERO TO AO-BRANCH.
103700     MOVE TX-TOTAL-PAGES (SAVEZ-III) TO AO-SEQ.
103800     MOVE AO-INDEX-RECORD TO AI-INDEX-RECORD.
103900     ADD +1 TO K-COUNT.
104000     WRITE AI-INDEX-RECORD INVALID KEY
104100              GO TO 9802-ERROR-INDEX-RECORD.
104200
104300 2479-EXIT.  EXIT.
104400
104500 2980-NO-MORE-SYSOUT.
104600     IF DEBUG-ON
104700        DISPLAY '2980-NO-MORE-SYSOUT'.
104800     MOVE 'Y' TO EOF-STATUS.
104900     PERFORM 1200-PROCESS-SYSOUT THRU 1499-PROCESS-EXIT.
105000     PERFORM 2200-PROCESS-SYSOUT.
105100
105200 2999-EXIT.  EXIT.
105300
105400 3000-CREATE-TITLE-RECORDS.
105500     MOVE 'N' TO GET-OUT-X.
105600     OPEN OUTPUT ADD-HISTORY-FILE
105700                 REPORT-LIST-FILE.
105800     PERFORM 3600-WRITE-TITLE-DATA THRU
105900             3699-BUILD-EXIT
106000             VARYING I FROM 1 BY 1
106100        UNTIL GET-OUT.
106200     MOVE 'N' TO GET-OUT-X.
106300     PERFORM 3700-WRITE-TITLE-DATA THRU
106400             3799-BUILD-EXIT
106500             VARYING I FROM 1 BY 1
106600        UNTIL GET-OUT.
106700     MOVE ALL '-' TO ADD-INDEX-H-RECORD.
106800     WRITE ADD-INDEX-H-RECORD
106900              INVALID KEY GO TO 9804-ERROR-HISTORY-RECORD.
107000     MOVE K-COUNT TO K-PRT-COUNT.
107100     MOVE K-PRT TO ADD-INDEX-H-RECORD.
107200     WRITE ADD-INDEX-H-RECORD
107300              INVALID KEY GO TO 9804-ERROR-HISTORY-RECORD.
107400     MOVE D-COUNT TO D-PRT-COUNT.
107500     MOVE D-PRT TO ADD-INDEX-H-RECORD.
107600     WRITE ADD-INDEX-H-RECORD
107700              INVALID KEY GO TO 9804-ERROR-HISTORY-RECORD.
107800     MOVE T-COUNT TO T-PRT-COUNT.
107900     MOVE T-PRT TO ADD-INDEX-H-RECORD.
108000     WRITE ADD-INDEX-H-RECORD
108100              INVALID KEY GO TO 9804-ERROR-HISTORY-RECORD.
108200     MOVE ALL '-' TO ADD-INDEX-H-RECORD.
108300     WRITE ADD-INDEX-H-RECORD
108400              INVALID KEY GO TO 9804-ERROR-HISTORY-RECORD.
108500     CLOSE ADD-HISTORY-FILE
108600           REPORT-LIST-FILE.
108700     GO TO 3999-EXIT.
108800
108900 3600-WRITE-TITLE-DATA.
109000     IF DEBUG-ON
109100        DISPLAY '3600-WRITE-TITLE-DATA'.
109200     IF (TX-REPORT-ID (I) EQUAL SPACES) AND
109300           (TX-REPORT-SID (I) EQUAL SPACES) AND
109400              (TX-BANK (I) EQUAL ZERO) AND
109500               (TX-BRANCH (I) EQUAL ZERO) AND
109600                 (TX-REPORT-DATE (I) EQUAL ZERO)
109700                 MOVE 'Y' TO GET-OUT-X
109800                 GO TO 3699-BUILD-EXIT
109900     END-IF.
110000     IF DEBUG-ON
110100        DISPLAY ' TX-REPORT-ID=' TX-REPORT-ID (I)
110200        DISPLAY ' TX-REPORT-SID=' TX-REPORT-SID (I)
110300        DISPLAY ' TX-BANK=' TX-BANK (I)
110400        DISPLAY ' TX-BRANCH=' TX-BRANCH (I)
110500        DISPLAY ' TX-REPORT-DATE=' TX-REPORT-DATE (I).
110600     IF TX-BRANCH (I) EQUAL ZERO
110700        NEXT SENTENCE
110800       ELSE
110900        GO TO 3699-BUILD-EXIT.
111000     MOVE SPACES TO AT-HISTORY-RECORD.
111100     MOVE 'T' TO AT-TYPE.
111200     MOVE TX-BANK (I) TO AT-BANK.
111300     MOVE TX-BRANCH (I) TO AT-BRANCH.
111400     MOVE TX-REPORT-ID (I) TO AT-REPORT-ID.
111500     MOVE TX-REPORT-SID (I) TO AT-REPORT-SID.
111600     MOVE TX-REPORT-DATE (I) TO AT-REPORT-DATE.
111700     MOVE TX-TITLE-NAME (I) TO AT-TITLE-NAME.
111800     MOVE TX-TOTAL-PAGES (I) TO AT-PAGES.
111900     MOVE TX-TOTAL-LINES (I) TO AT-LINES.
112000     MOVE TX-REPORT-FILE (I) TO AT-REPORT-FILE.
112100     ADD +1 TO T-COUNT.
112200     WRITE AT-HISTORY-RECORD
112300              INVALID KEY GO TO 9803-ERROR-TINDEX-RECORD.
112400*    IF TX-REPORT-SID (I) NOT EQUAL SPACES
112500*                GO TO 3699-BUILD-EXIT
112600*    END-IF.
112700     INITIALIZE ADD-INDEX-H-RECORD.
112800     MOVE TX-REPORT-ID (I) TO HS-REPORT-ID.
112900     MOVE TX-REPORT-SID (I) TO HS-REPORT-SID.
113000     MOVE TX-REPORT-DATE (I) TO HS-REPORT-DATE.
113100     MOVE TX-TITLE-NAME (I) TO HS-TITLE-NAME.
113200     MOVE TX-TOTAL-PAGES (I) TO HS-PAGES.
113300     MOVE TX-TOTAL-LINES (I) TO HS-LINES.
113400     MOVE 'O' TO HS-STATUS.
113500     MOVE TX-REPORT-FILE (I) TO HS-REPORT-FILE.
113600     WRITE ADD-INDEX-H-RECORD
113700              INVALID KEY GO TO 9804-ERROR-HISTORY-RECORD.
113800
113900 3699-BUILD-EXIT.  EXIT.
114000
114100 3700-WRITE-TITLE-DATA.
114200     IF DEBUG-ON
114300        DISPLAY '3700-WRITE-TITLE-DATA'.
114400     IF (TZ-REPORT-ID (I) EQUAL SPACES) AND
114500           (TZ-REPORT-SID (I) EQUAL SPACES) AND
114600              (TZ-BANK (I) EQUAL ZERO) AND
114700                 (TZ-BRANCH (I) EQUAL ZERO) AND
114800                   (TZ-REPORT-DATE (I) EQUAL ZERO)
114900                 MOVE 'Y' TO GET-OUT-X
115000                 GO TO 3799-BUILD-EXIT
115100     END-IF.
115200     IF DEBUG-ON
115300        DISPLAY ' TZ-REPORT-ID=' TZ-REPORT-ID (I)
115400        DISPLAY ' TZ-REPORT-SID=' TZ-REPORT-SID (I)
115500        DISPLAY ' TZ-BANK=' TZ-BANK (I)
115600        DISPLAY ' TZ-BRANCH=' TZ-BRANCH (I)
115700        DISPLAY ' TZ-REPORT-DATE=' TZ-REPORT-DATE (I).
115800     IF TZ-BRANCH (I) EQUAL ZERO
115900        GO TO 3799-BUILD-EXIT.
116000     MOVE SPACES TO AT-HISTORY-RECORD.
116100     MOVE 'T' TO AT-TYPE.
116200     MOVE TZ-BANK (I) TO AT-BANK.
116300     MOVE TZ-BRANCH (I) TO AT-BRANCH.
116400     MOVE TZ-REPORT-ID (I) TO AT-REPORT-ID.
116500     MOVE TZ-REPORT-SID (I) TO AT-REPORT-SID.
116600     MOVE TZ-REPORT-DATE (I) TO AT-REPORT-DATE.
116700     MOVE TZ-TITLE-NAME (I) TO AT-TITLE-NAME.
116800     MOVE TZ-TOTAL-PAGES (I) TO AT-PAGES.
116900     MOVE TZ-TOTAL-LINES (I) TO AT-LINES.
117000     MOVE TZ-REPORT-FILE (I) TO AT-REPORT-FILE.
117100     ADD +1 TO T-COUNT.
117200     WRITE AT-HISTORY-RECORD
117300              INVALID KEY GO TO 9803-ERROR-TINDEX-RECORD.
117400*    IF TZ-REPORT-SID (I) NOT EQUAL SPACES
117500*                GO TO 3799-BUILD-EXIT
117600*    END-IF.
117700     INITIALIZE ADD-INDEX-H-RECORD.
117800     MOVE TZ-REPORT-ID (I) TO HS-REPORT-ID.
117900     MOVE TZ-REPORT-SID (I) TO HS-REPORT-SID.
118000     MOVE TZ-REPORT-DATE (I) TO HS-REPORT-DATE.
118100     MOVE TZ-TITLE-NAME (I) TO HS-TITLE-NAME.
118200     MOVE TZ-TOTAL-PAGES (I) TO HS-PAGES.
118300     MOVE TZ-TOTAL-LINES (I) TO HS-LINES.
118400     MOVE 'O' TO HS-STATUS.
118500     MOVE TZ-REPORT-FILE (I) TO HS-REPORT-FILE.
118600     WRITE ADD-INDEX-H-RECORD
118700              INVALID KEY GO TO 9804-ERROR-HISTORY-RECORD.
118800
118900 3799-BUILD-EXIT.  EXIT.
119000
119100 3999-EXIT.  EXIT.
119200
119300*********************************************************
119400*     ERROR ROUTINES AND EOJ         ********************
119500*********************************************************
119600
119700 9800-ERROR-WRITE-DETAIL.
119800     DISPLAY '*** ERROR WRITING DETAIL RECORD **'.
119900     MOVE 18 TO RETURN-CODE.
120000     GO TO 9999-END-OF-PROGRAM.
120100
120200 9802-ERROR-INDEX-RECORD.
120300     DISPLAY '*** ERROR WRITING INDEX RECORD ***'.
120400     MOVE 16 TO RETURN-CODE.
120500     GO TO 9999-END-OF-PROGRAM.
120600
120700 9803-ERROR-TINDEX-RECORD.
120800     DISPLAY '*** ERROR WRITING TITLE INDEX RECORD ***'.
120900     MOVE 26 TO RETURN-CODE.
121000     GO TO 9999-END-OF-PROGRAM.
121100
121200 9804-ERROR-HISTORY-RECORD.
121300     DISPLAY '*** ERROR WRITING HISTORY RECORD ***'.
121400     MOVE 28 TO RETURN-CODE.
121500     GO TO 9999-END-OF-PROGRAM.
121600
121700 9900-NO-INPUT-CARD.
121800     DISPLAY '*** NO CONTROL CARD ***'.
121900     MOVE 20 TO RETURN-CODE.
122000     GO TO 9999-END-OF-PROGRAM.
122100
122200 9902-TITLE-ARRAY-ERROR.
122300     DISPLAY '*** TITLE ARRAY IS FULL ***'.
122400     DISPLAY '*** INCREASE ARRAY IN PROGRAM ***'.
122500     MOVE 22 TO RETURN-CODE.
122600     GO TO 9999-END-OF-PROGRAM.
122700
122800 9903-TITLE-INDEX-ARRAY-ERROR.
122900     DISPLAY '*** TITLE INDEX ARRAY IS FULL ***'.
123000     DISPLAY '*** INCREASE ARRAY IN PROGRAM ***'.
123100     MOVE 24 TO RETURN-CODE.
123200     GO TO 9999-END-OF-PROGRAM.
123300
123400 9999-END-OF-PROGRAM.
123500     STOP RUN.
