000100 IDENTIFICATION DIVISION.
000200 PROGRAM-ID.        REPT126.
000300
000400 AUTHOR.            BILLY FENWICK
000500
000600*  READS THE PURGE-RECORDS FILE AND DELETES RECORDS
000700*  THE MATCHING RECORDS FROM THE ONLINE REPORT DETAIL FILE.
000800*
000600****************************************
000610*     (C) COPYRIGHT BILLY FENWICK
000620****************************************
000900 ENVIRONMENT DIVISION.
001000 CONFIGURATION SECTION.
001100 INPUT-OUTPUT SECTION.
001200 FILE-CONTROL.
001300     SELECT REPORT-DETAIL-FILE  ASSIGN TO DA-DTLIN
001400                         ORGANIZATION IS INDEXED
001500                         ACCESS IS DYNAMIC
001600                         FILE STATUS IS DTL-STATUS
001700                         RECORD KEY IS D-KEY.
001800     SELECT PURGE-RECORDS      ASSIGN TO UT-S-PURGED.
001900     SELECT REPORT-LIST-FILE   ASSIGN TO UT-S-REPTLST.
002000
002100 DATA DIVISION.
002200 FILE SECTION.
002300
002400 FD  PURGE-RECORDS
002500     RECORDING MODE IS F
002600     RECORD CONTAINS 14.
002700 01  PURGE-RECORD.
002800     03 P-REPORT-ID            PIC X(8).
002900     03 P-REPORT-DATE          PIC 9(6).
003000
003100 FD  REPORT-DETAIL-FILE
003200     RECORD CONTAINS 153 TO 11724.
003300     COPY REPTB05 REPLACING ==:Z:== BY ==D==.
003400
003500 FD  REPORT-LIST-FILE
003600     RECORDING MODE IS F
003700     RECORD CONTAINS 132.
003800 01  ADD-PRINT-RECORD.
003900     03 PRT-ONE                 PIC X(50).
004000     03 PRT-XYZ                 PIC X(82).
004100     03 X-FIL REDEFINES PRT-XYZ.
004200        05 PRT-ID                  PIC X(8).
004300        05 FILLER                  PIC X(1).
004400        05 PRT-DATE                PIC 9(6).
004500        05 FILLER                  PIC X(1).
004600        05 PRT-SEQ                 PIC 9(7).
004700        05 FILLER                  PIC X(59).
004800     03 X-FILL REDEFINES PRT-XYZ.
004900        05 PRT-NUMBER              PIC ZZZ,Z99.
005000        05 FILLER                  PIC X(75).
005100
005200 WORKING-STORAGE SECTION.
005300 77  DD-COUNT      PIC S9(7) COMP-3  VALUE ZERO.
005400 77  DI-COUNT      PIC S9(7) COMP-3  VALUE ZERO.
005500 77  DD-SEQ        PIC S9(7)         VALUE ZERO.
005600 77  DTL-STATUS    PIC X(2)          VALUE 'ZZ'.
005700
005800 EJECT
005900
006000 LINKAGE SECTION.
006100 01  LINK-WORK-AREA.
006200     03  PARM-LENGTH   PIC S9(4) COMP.
006300     03  JOB-PARM      PIC X(5).
006400        88 DEBUG-ON  VALUE 'DEBUG'.
006500        88 REPORT-ON VALUE 'REPRT'.
006600
006700 EJECT
006800 PROCEDURE DIVISION USING LINK-WORK-AREA.
006900 0000-MAIN-ROUTINE.
007000
007100     OPEN OUTPUT REPORT-LIST-FILE.
007200     OPEN INPUT PURGE-RECORDS
007300          I-O REPORT-DETAIL-FILE.
007310     IF REPORT-ON
007320        MOVE ALL '-' TO ADD-PRINT-RECORD
007330        WRITE ADD-PRINT-RECORD
007340     END-IF.
007400
007500 2000-READ-PURGE-RECORD.
007600     READ PURGE-RECORDS AT END GO TO 9000-CLOSE-FILES.
007700
007800 3100-PURGE-DETAIL-RECORDS.
007900     MOVE LOW-VALUES TO D-RECORD.
008000     MOVE P-REPORT-DATE TO D-REPORT-DATE.
008100     MOVE P-REPORT-ID TO D-REPORT-ID.
008200     START REPORT-DETAIL-FILE KEY IS GREATER THAN D-KEY
008300        INVALID KEY GO TO 9300-BAD-START.
008400     IF DTL-STATUS NOT EQUAL ZERO
008500        GO TO 9300-BAD-START.
008600
008700 3150-READ-DETAIL-FILE.
008800     READ REPORT-DETAIL-FILE NEXT RECORD AT END
008900        GO TO 2000-READ-PURGE-RECORD.
009000     IF (D-REPORT-ID EQUAL P-REPORT-ID) AND
009100        (D-REPORT-DATE EQUAL P-REPORT-DATE )
009200        GO TO 3200-DELETE-RECORD.
009300     GO TO 2000-READ-PURGE-RECORD.
009400
009500 3200-DELETE-RECORD.
009600     MOVE D-SEQ TO DD-SEQ.
009700     IF REPORT-ON
010000        MOVE SPACES TO ADD-PRINT-RECORD
010100        MOVE '  RECORD DELETED ---' TO PRT-ONE
010110        MOVE D-REPORT-ID TO PRT-ID
010200        MOVE D-REPORT-DATE TO PRT-DATE
010300        MOVE D-SEQ TO PRT-SEQ
010400        WRITE ADD-PRINT-RECORD
010500     END-IF.
010600     IF DEBUG-ON
010700       DISPLAY D-REPORT-DATE ' ' D-REPORT-ID ' ' DD-SEQ.
010800     ADD 1 TO DD-COUNT.
010900     DELETE REPORT-DETAIL-FILE RECORD  INVALID KEY
011000        GO TO 9920-DETAIL-FILE.
011100     IF DTL-STATUS NOT EQUAL ZERO
011200        GO TO 9920-DETAIL-FILE.
011300     GO TO 3150-READ-DETAIL-FILE.
011400
011500
011600 9000-CLOSE-FILES.
011700     IF REPORT-ON
011800        MOVE ALL '-' TO ADD-PRINT-RECORD
011900        WRITE ADD-PRINT-RECORD
012000        MOVE SPACES TO ADD-PRINT-RECORD
012100        MOVE ' TOTAL DETAIL RECORDS DELETED.' TO PRT-ONE
012200        MOVE DD-COUNT TO PRT-NUMBER
012300        WRITE ADD-PRINT-RECORD
012400        MOVE ALL '-' TO ADD-PRINT-RECORD
012500        WRITE ADD-PRINT-RECORD
012600     END-IF.
012700     CLOSE PURGE-RECORDS
012800           REPORT-DETAIL-FILE.
012900     GO TO 9999-END-OF-PROGRAM.
013000
013100 9300-BAD-START.
013200     DISPLAY '*** INVALID START BROWSE ON FILE DTLIN**'.
013300     DISPLAY 'VSAM STATUS CODE=' DTL-STATUS.
013400     MOVE 16 TO RETURN-CODE
013500     GO TO 9000-CLOSE-FILES.
013600
013700 9920-DETAIL-FILE.
013800     DISPLAY '*** WRITE ERROR ON DETAIL-FILE ***'.
013900     DISPLAY 'VSAM STATUS CODE=' DTL-STATUS.
014000     MOVE 14 TO RETURN-CODE
014100     GO TO 9000-CLOSE-FILES.
014200
014300 9999-END-OF-PROGRAM.
014400     STOP RUN.
