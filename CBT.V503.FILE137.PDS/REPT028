000100 IDENTIFICATION DIVISION.
000200 PROGRAM-ID.        REPT028.
000300
000400 AUTHOR.            BILLY FENWICK
000500
000600*  READS THE ONLINE REPORT HISTORY FILE, THE NEW HISTORY
000700*  RECORDS FILE AND DELETES ALL RECORDS THAT SHOULD BE
000800*  DELETED AND CREATES A NEW HISTORY FILE.
000600****************************************
000610*     (C) COPYRIGHT BILLY FENWICK
000620****************************************
000900 ENVIRONMENT DIVISION.
001000 CONFIGURATION SECTION.
001100 INPUT-OUTPUT SECTION.
001200 FILE-CONTROL.
001300     SELECT REPORT-HISTORY-FILE   ASSIGN TO DA-HSTIN
001400                         ORGANIZATION IS INDEXED
001500                         ACCESS IS SEQUENTIAL
001600                         FILE STATUS IS HST-STATUS
001700                         RECORD KEY IS OT-KEY.
001800     SELECT NEW-REPORT-HISTORY-FILE   ASSIGN TO DA-HSTNEW
001900                         ORGANIZATION IS INDEXED
002000                         ACCESS IS SEQUENTIAL
002100                         FILE STATUS IS NEW-STATUS
002200                  RECORD KEY IS NT-KEY IN NT-HISTORY-RECORD.
002300     SELECT ADD-HISTORY-FILE   ASSIGN TO UT-S-HSTADD.
002400     SELECT PURGE-RECORDS      ASSIGN TO UT-S-PURGEH.
002500     SELECT SORT-FILE          ASSIGN TO UT-S-SORTWK1.
002510     SELECT REPORT-LIST-FILE   ASSIGN TO UT-S-REPTLST.
002600
002700 DATA DIVISION.
002800 FILE SECTION.
002900
003000 FD  NEW-REPORT-HISTORY-FILE
003100     RECORD CONTAINS 100.
003200     COPY REPTB07 REPLACING ==:Z:== BY ==NT==.
003300
003400 FD  PURGE-RECORDS
003500     RECORDING MODE F
003600     RECORD CONTAINS 14.
003700 01  PURGE-RECORD.
003800     03 P-REPORT-ID            PIC X(8).
003900     03 P-REPORT-DATE          PIC 9(6).
004000
004100 FD  REPORT-HISTORY-FILE
004200     RECORD CONTAINS 100.
004300     COPY REPTB07 REPLACING ==:Z:== BY ==OT==.
004400
004500 FD  ADD-HISTORY-FILE
004600     RECORDING MODE F
004700     RECORD CONTAINS 100.
004800     COPY REPTB07 REPLACING ==:Z:== BY ==AT==.
004900
005000 SD  SORT-FILE
005100     RECORD CONTAINS 100.
005200     COPY REPTB07 REPLACING ==:Z:== BY ==ST==.
005210
005220 FD  REPORT-LIST-FILE
005230     RECORDING MODE IS F
005240     RECORD CONTAINS 132.
005250 01  ADD-PRINT-RECORD.
005260     03 PRT-ONE                 PIC X(50).
005270     03 PRT-XYZ                 PIC X(82).
005280     03 FILLER REDEFINES PRT-XYZ.
005290        05 PRT-ID                  PIC X(8).
005291        05 FILLER                  PIC X(1).
005292        05 PRT-SID                 PIC X(8).
005293        05 FILLER                  PIC X(1).
005294        05 PRT-DATE                PIC 9(6).
005295        05 FILLER                  PIC X(1).
005296        05 PRT-BANK                PIC 9(3).
005297        05 FILLER                  PIC X(1).
005298        05 PRT-BRANCH              PIC 9(3).
005299        05 FILLER                  PIC X(1).
005300        05 PRT-SEQ                 PIC 9(7).
005301        05 FILLER                  PIC X(42).
005302      03 FILLER REDEFINES PRT-XYZ.
005303         05 PRT-NUMBER              PIC ZZZ,Z99.
005304         05 FILLER                  PIC X(75).
005310
005400 WORKING-STORAGE SECTION.
005500 77  WK-ARRAY-COUNT    PIC S9(7) COMP-3  VALUE ZERO.
005600 77  DD-DEL-COUNT      PIC S9(7) COMP-3  VALUE ZERO.
005700 77  DD-DEL-T-COUNT    PIC S9(7) COMP-3  VALUE ZERO.
005800 77  DD-ADD-COUNT      PIC S9(7) COMP-3  VALUE ZERO.
005900 77  DD-TOT-COUNT      PIC S9(7) COMP-3  VALUE ZERO.
006000 77  DD-VSM-COUNT      PIC S9(7) COMP-3  VALUE ZERO.
006100 77  DD-WRT-T-COUNT    PIC S9(7) COMP-3  VALUE ZERO.
006200 77  DD-WRT-COUNT      PIC S9(7) COMP-3  VALUE ZERO.
006300 77  DD-ADD-T-COUNT    PIC S9(7) COMP-3  VALUE ZERO.
006400 77  DD-OLD-T-COUNT    PIC S9(7) COMP-3  VALUE ZERO.
006500 77  DD-SEQ            PIC S9(7)         VALUE ZERO.
006600 77  I                 PIC S9(8) COMP    VALUE ZERO.
006700 77  HST-STATUS        PIC X(2)          VALUE 'ZZ'.
006800 77  NEW-STATUS        PIC X(2)          VALUE 'ZZ'.
006900 77  GOT-IT            PIC X(1)          VALUE ' '.
007000 77  OK-OUT            PIC X(1)          VALUE ' '.
007100 77  OLD-REPORT-ID     PIC X(8)          VALUE SPACES.
007200 77  OLD-REPORT-DATE   PIC 9(6)          VALUE ZERO.
007300
007400 01  WORK-AREAS.
007500     03  PURGE-ARRAY OCCURS 3000 TIMES.
007600         05 WRK-REPORT-ID        PIC X(8).
007700         05 WRK-REPORT-DATE      PIC 9(6).
007800     COPY REPTB07 REPLACING ==:Z:== BY ==WK==.
007900
007910 LINKAGE SECTION.
007920 01  LINK-WORK-AREA.
007930     03  PARM-LENGTH   PIC S9(4) COMP.
007940     03  JOB-PARM      PIC X(5).
007950        88 DEBUG-ON  VALUE 'DEBUG'.
007960        88 REPORT-ON VALUE 'REPRT'.
007970
007980 EJECT
007990 PROCEDURE DIVISION USING LINK-WORK-AREA.
008200 0000-MAIN-ROUTINE SECTION.
008300
008400 0100-OPEN-FILES.
008500     OPEN INPUT PURGE-RECORDS, REPORT-HISTORY-FILE,
008600          ADD-HISTORY-FILE.
008700     OPEN OUTPUT NEW-REPORT-HISTORY-FILE, REPORT-LIST-FILE.
008800
008900 0200-READ-PURGE-RECORDS.
009000     ADD 1 TO I.
009100     IF I = WK-ARRAY-COUNT
009200        GO TO 9300-OUT-SPACE.
009300     READ PURGE-RECORDS AT END GO TO 0900-CLOSE-PURGE-FILE.
009400     MOVE P-REPORT-ID TO  WRK-REPORT-ID (I).
009500     MOVE P-REPORT-DATE TO WRK-REPORT-DATE (I).
009510     IF REPORT-ON
009520        MOVE ALL '-' TO ADD-PRINT-RECORD
009530        WRITE ADD-PRINT-RECORD
009550     END-IF.
009560     IF REPORT-ON
009570        MOVE SPACES TO ADD-PRINT-RECORD
009580        MOVE '--- TO BE DELETED=' TO PRT-ONE
009590        MOVE P-REPORT-ID TO PRT-ID
009591        MOVE P-REPORT-DATE TO PRT-DATE
009592        WRITE ADD-PRINT-RECORD
009594     END-IF.
009600     GO TO 0200-READ-PURGE-RECORDS.
009700
009800 0900-CLOSE-PURGE-FILE.
009900     MOVE 'ZZZZZZZZ' TO WRK-REPORT-ID (I).
010000     MOVE 999999 TO WRK-REPORT-DATE (I).
010100     CLOSE PURGE-RECORDS.
010200     MOVE 1 TO I.
010300
010400 1000-SORT-HISTORY-FILE SECTION.
010500     SORT SORT-FILE
010600        ON ASCENDING KEY ST-KEY
010700        INPUT PROCEDURE
010800          3000-START-SORT THRU 4000-END-SORT
010900        OUTPUT PROCEDURE
011000          5000-START-LOAD THRU 7000-END-LOAD.
011100
011200     IF SORT-RETURN NOT EQUAL 0
011300        DISPLAY 'REPT027 - SORT ERROR, JOB ABENDED'
011400        MOVE 16 TO RETURN-CODE.
011500     GO TO 9000-CLOSE-FILES.
011600
011700 3000-START-SORT SECTION.
011800     READ REPORT-HISTORY-FILE AT END
011900        GO TO 3400-DO-SEQ-FILE.
012000     ADD 1 TO DD-VSM-COUNT.
012100     IF OT-TYPE = 'T' AND
012200        OT-REPORT-ID EQUAL WRK-REPORT-ID (I) AND
012300        OT-REPORT-DATE EQUAL WRK-REPORT-DATE (I)
012400        ADD 1 TO DD-DEL-COUNT, DD-DEL-T-COUNT
012410        PERFORM 3350-PRINT-DELETE
012500        GO TO 3000-START-SORT.
012600     IF OT-TYPE = 'T' AND
012700        (OT-REPORT-ID EQUAL OLD-REPORT-ID ) AND
012800        (OT-REPORT-DATE EQUAL OLD-REPORT-DATE )
012900        GO TO 3100-RELEASE-IT.
013000     IF OT-TYPE = 'T'
013100        GO TO 3130-CHECK-T-TYPE.
013200     GO TO 3000-START-SORT.
013300
013400 3100-RELEASE-IT.
013500     ADD 1 TO DD-TOT-COUNT.
013600     ADD 1 TO DD-OLD-T-COUNT
013700     RELEASE ST-HISTORY-RECORD FROM OT-HISTORY-RECORD.
013800     GO TO 3000-START-SORT.
013900
014000 3130-CHECK-T-TYPE.
014100     PERFORM 3300-FIND-T-REPORT-ID.
014200     IF GOT-IT EQUAL 'Y'
014300        ADD 1 TO DD-DEL-COUNT, DD-DEL-T-COUNT
014310        PERFORM 3350-PRINT-DELETE
014400        GO TO 3000-START-SORT.
014500     GO TO 3100-RELEASE-IT.
014600
014700 3300-FIND-T-REPORT-ID.
014800     MOVE 'N' TO OK-OUT.
014900     MOVE OT-REPORT-ID TO OLD-REPORT-ID.
015000     MOVE OT-REPORT-DATE TO OLD-REPORT-DATE.
015100     PERFORM 3310-CHECK-IT VARYING I FROM 1 BY 1
015200       UNTIL OK-OUT = 'Y'.
015300     SUBTRACT 1 FROM I.
015400
015500 3310-CHECK-IT.
015600     IF WRK-REPORT-ID (I) EQUAL OT-REPORT-ID AND
015700        WRK-REPORT-DATE (I) EQUAL OT-REPORT-DATE
015800        MOVE 'Y' TO OK-OUT, GOT-IT.
015900     IF WRK-REPORT-ID (I) EQUAL 'ZZZZZZZZ' AND
016000        WRK-REPORT-DATE (I) EQUAL 999999
016100        MOVE 'N' TO GOT-IT
016200        MOVE 'Y' TO OK-OUT.
016300     IF I EQUAL 3000
016400        MOVE 'N' TO GOT-IT
016500        MOVE 'Y' TO OK-OUT.
016510
016520 3350-PRINT-DELETE.
016530     IF REPORT-ON
016540        MOVE SPACES TO ADD-PRINT-RECORD
016550        MOVE '-  RECORD DELETED=' TO PRT-ONE
016560        MOVE OT-REPORT-ID TO PRT-ID
016570        MOVE OT-REPORT-SID TO PRT-SID
016580        MOVE OT-REPORT-DATE TO PRT-DATE
016590        WRITE ADD-PRINT-RECORD
016591     END-IF.
016600
016700 3400-DO-SEQ-FILE.
016800     CLOSE REPORT-HISTORY-FILE.
016900
017000 3500-READ-SEQ-FILE.
017100     READ ADD-HISTORY-FILE AT END
017200        GO TO 3900-CLOSE-ADD-FILE.
017300     ADD 1 TO DD-ADD-COUNT.
017400     ADD 1 TO DD-TOT-COUNT.
017500     PERFORM 3600-RELEASE.
017600     GO TO 3500-READ-SEQ-FILE.
017700
017800 3600-RELEASE.
017900     ADD 1 TO DD-ADD-T-COUNT.
018000     RELEASE ST-HISTORY-RECORD FROM AT-HISTORY-RECORD.
018100
018200 3900-CLOSE-ADD-FILE.
018300     CLOSE ADD-HISTORY-FILE.
018400
018500 4000-END-SORT. EXIT.
018600
018700 5000-START-LOAD SECTION.
018800     RETURN SORT-FILE RECORD INTO WK-HISTORY-RECORD
018900         AT END GO TO 6900-CLOSE-FILE.
019000     ADD 1 TO DD-WRT-COUNT.
019100     PERFORM 5200-LOAD-FILE.
019200     GO TO 5000-START-LOAD.
019300
019400 5200-LOAD-FILE.
019500     ADD 1 TO DD-WRT-T-COUNT
019600     MOVE WK-HISTORY-RECORD TO NT-HISTORY-RECORD
019700     WRITE NT-HISTORY-RECORD INVALID KEY GO TO 5298-ERROR.
019800     IF NEW-STATUS NOT EQUAL ZERO
019900        GO TO 5298-ERROR.
020000
020100 5298-ERROR.
020200     DISPLAY '---ERROR WRITING TO OUTPUT VSAM FILE-----------'.
020300     DISPLAY '*****START OF RECORD*********'.
020400     DISPLAY WK-HISTORY-RECORD.
020500     DISPLAY 'VSAM FILE STATUS=' NEW-STATUS.
020600     DISPLAY '*****END OF RECORD*********'.
020700     MOVE 16 TO RETURN-CODE.
020800
020900 6900-CLOSE-FILE.
021000     CLOSE NEW-REPORT-HISTORY-FILE.
021100
021200 7000-END-LOAD. EXIT.
021300
021400 9000-CLOSE-FILES SECTION.
021500*    DISPLAY '-----------------------------------------------'.
021600*    DISPLAY DD-VSM-COUNT ' TOTAL VSAM HISTORY RECORDS READ IN'.
021700*    DISPLAY '-----------------------------------------------'.
021800*    DISPLAY DD-OLD-T-COUNT ' T HISTORY KEPT FROM INPUT FILE.'.
021900*    DISPLAY '-----------------------------------------------'.
022200*    DISPLAY DD-DEL-COUNT ' TOTAL HISTORY RECORDS DELETED.'.
022300*    DISPLAY DD-DEL-T-COUNT '     T HISTORY RECORDS DELETED.'.
022400*    DISPLAY '-----------------------------------------------'.
022500*    DISPLAY DD-ADD-COUNT ' TOTAL HISTORY RECORDS ADDED.'.
022600*    DISPLAY DD-ADD-T-COUNT '     T HISTORY RECORDS ADDED.'.
022700*    DISPLAY '------------------------------------------------'.
022800*    DISPLAY DD-WRT-COUNT ' VSAM HISTORY RECORDS WRITTEN OUT.'
022900*    DISPLAY DD-WRT-T-COUNT '     T HISTORY RECORDS WRITTEN OUT.'
023000*    DISPLAY '------------------------------------------------'.
023010     MOVE ALL '-' TO ADD-PRINT-RECORD.
023020     WRITE ADD-PRINT-RECORD.
023030     MOVE SPACES TO ADD-PRINT-RECORD.
023040     MOVE ' TOTAL VSAM HISTORY RECORDS READ IN  ' TO PRT-ONE.
023050     MOVE DD-VSM-COUNT TO PRT-NUMBER.
023060     WRITE ADD-PRINT-RECORD.
023070     MOVE ALL '-' TO ADD-PRINT-RECORD.
023080     WRITE ADD-PRINT-RECORD.
023090     MOVE SPACES TO ADD-PRINT-RECORD.
023091     MOVE '   HISTORY RECORDS KEPT FROM INPUT FILE ' TO PRT-ONE.
023092     MOVE DD-OLD-T-COUNT TO PRT-NUMBER.
023093     WRITE ADD-PRINT-RECORD.
023094     MOVE ALL '-' TO ADD-PRINT-RECORD.
023095     WRITE ADD-PRINT-RECORD.
023096     MOVE SPACES TO ADD-PRINT-RECORD.
023097     MOVE '   HISTORY RECORDS DELETED.' TO PRT-ONE.
023098     MOVE DD-DEL-T-COUNT TO PRT-NUMBER.
023099     WRITE ADD-PRINT-RECORD.
023100     MOVE ALL '-' TO ADD-PRINT-RECORD.
023101     WRITE ADD-PRINT-RECORD.
023102     MOVE SPACES TO ADD-PRINT-RECORD.
023103     MOVE '   HISTORY RECORDS ADDED.' TO PRT-ONE.
023104     MOVE DD-ADD-T-COUNT TO PRT-NUMBER.
023105     WRITE ADD-PRINT-RECORD.
023106     MOVE ALL '-' TO ADD-PRINT-RECORD.
023107     WRITE ADD-PRINT-RECORD.
023108     MOVE SPACES TO ADD-PRINT-RECORD.
023109     MOVE ' TOTAL HISTORY RECORDS WRITTEN OUT.' TO PRT-ONE.
023110     MOVE DD-WRT-T-COUNT TO PRT-NUMBER.
023111     WRITE ADD-PRINT-RECORD.
023112     MOVE ALL '-' TO ADD-PRINT-RECORD.
023113     WRITE ADD-PRINT-RECORD.
023114     CLOSE REPORT-LIST-FILE.
023120     GO TO 9999-END-OF-PROGRAM.
023200
023300 9300-OUT-SPACE.
023400     DISPLAY '*** OUT OF SPACE IN PURGE ARRAY**'.
023500     MOVE 16 TO RETURN-CODE
023600     GO TO 9000-CLOSE-FILES.
023700
023800 9999-END-OF-PROGRAM.
023900     STOP RUN.
024000
